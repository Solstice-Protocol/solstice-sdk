# Release Pipeline
# Triggered on version tags (v*.*.*)
# Handles package publishing, GitHub releases, and production deployment

name: Release Pipeline

on:
  push:
    tags:
      - 'v*.*.*'

env:
  NODE_VERSION: '18'
  REGISTRY_URL: 'https://registry.npmjs.org'

jobs:
  # Validate release prerequisites
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.prerelease }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Check if this is a prerelease (contains alpha, beta, rc)
          if [[ $VERSION =~ (alpha|beta|rc) ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi
          
          echo "Release version: $VERSION"
          echo "Is prerelease: $(echo $VERSION | grep -E '(alpha|beta|rc)' && echo true || echo false)"
      
      - name: Validate package.json version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if [ "$PACKAGE_VERSION" != "${{ steps.version.outputs.version }}" ]; then
            echo "âŒ Package.json version ($PACKAGE_VERSION) doesn't match tag version (${{ steps.version.outputs.version }})"
            exit 1
          fi
          echo "âœ… Package.json version matches tag version"

  # Run full CI pipeline for release
  ci-for-release:
    name: CI for Release
    uses: ./.github/workflows/ci.yml
    needs: validate-release

  # Build release artifacts
  build-release:
    name: Build Release
    runs-on: ubuntu-latest
    needs: [validate-release, ci-for-release]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: ${{ env.REGISTRY_URL }}
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build for release
        run: npm run build
      
      - name: Generate documentation
        run: |
          if npm run docs --if-present; then
            echo "âœ… Documentation generated successfully"
          else
            echo "âš ï¸ Documentation generation failed or not configured"
          fi
      
      - name: Package for release
        run: |
          # Create a clean package for publishing
          npm pack --dry-run
          
          # Verify package contents
          echo "Package contents:"
          npm pack --dry-run 2>/dev/null | grep -E '\.(js|ts|json|md)$' | head -20
      
      - name: Store release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ needs.validate-release.outputs.version }}
          path: |
            dist/
            circuits/
            docs/
            package.json
            README.md
            LICENSE
          retention-days: 90

  # Publish to npm
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: [validate-release, build-release]
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: ${{ env.REGISTRY_URL }}
      
      - name: Install dependencies
        run: npm ci
      
      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.validate-release.outputs.version }}
      
      - name: Publish to npm
        run: |
          if [ "${{ needs.validate-release.outputs.is-prerelease }}" == "true" ]; then
            echo "Publishing prerelease to npm with beta tag"
            npm publish --tag beta
          else
            echo "Publishing stable release to npm"
            npm publish
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Verify package publication
        run: |
          sleep 30  # Wait for npm registry to update
          PUBLISHED_VERSION=$(npm view @solsticeprotocol/sdk version)
          if [ "$PUBLISHED_VERSION" == "${{ needs.validate-release.outputs.version }}" ]; then
            echo "âœ… Package successfully published and verified"
          else
            echo "âŒ Package publication verification failed"
            echo "Expected: ${{ needs.validate-release.outputs.version }}"
            echo "Published: $PUBLISHED_VERSION"
            exit 1
          fi

  # Create GitHub release
  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-release, publish-npm]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.validate-release.outputs.version }}
          path: ./release-artifacts
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Generating changelog from $PREVIOUS_TAG to ${{ github.ref_name }}"
            
            # Generate changelog from commits
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD | head -50)
            
            # Create changelog file
            cat > CHANGELOG.md << EOF
          # Release ${{ needs.validate-release.outputs.version }}
          
          ## Changes
          $CHANGELOG
          
          ## Installation
          \`\`\`bash
          npm install @solsticeprotocol/sdk@${{ needs.validate-release.outputs.version }}
          \`\`\`
          
          ## Documentation
          - [API Documentation](https://github.com/Solstice-Protocol/sdk/tree/${{ github.ref_name }}/docs)
          - [Examples](https://github.com/Solstice-Protocol/sdk/tree/${{ github.ref_name }}/examples)
          EOF
          else
            echo "No previous tag found, creating initial release changelog"
            cat > CHANGELOG.md << EOF
          # Release ${{ needs.validate-release.outputs.version }}
          
          Initial release of the Solstice Protocol SDK.
          
          ## Installation
          \`\`\`bash
          npm install @solsticeprotocol/sdk@${{ needs.validate-release.outputs.version }}
          \`\`\`
          EOF
          fi
      
      - name: Create GitHub Release
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ needs.validate-release.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ needs.validate-release.outputs.is-prerelease }}
      
      - name: Upload release assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./release-artifacts/dist/
          asset_name: solstice-sdk-${{ needs.validate-release.outputs.version }}-dist.tar.gz
          asset_content_type: application/gzip

  # Deploy to production (if applicable)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate-release, create-github-release]
    if: needs.validate-release.outputs.is-prerelease == 'false'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy documentation
        run: |
          echo "Deploying documentation to production..."
          # Add documentation deployment logic here
          # This could deploy to GitHub Pages, Netlify, Vercel, etc.
          echo "âœ… Documentation deployment completed"
      
      - name: Notify deployment success
        run: |
          echo "ðŸš€ Production deployment completed successfully"
          echo "Version: ${{ needs.validate-release.outputs.version }}"
          echo "Package: https://www.npmjs.com/package/@solsticeprotocol/sdk"
          echo "Release: https://github.com/Solstice-Protocol/sdk/releases/tag/${{ github.ref_name }}"

  # Final release status
  release-status:
    name: Release Status
    runs-on: ubuntu-latest
    needs: [validate-release, ci-for-release, build-release, publish-npm, create-github-release, deploy-production]
    if: always()
    
    steps:
      - name: Report release status
        run: |
          echo "ðŸ“Š Release Pipeline Status Report"
          echo "=================================="
          echo "Version: ${{ needs.validate-release.outputs.version }}"
          echo "Prerelease: ${{ needs.validate-release.outputs.is-prerelease }}"
          echo ""
          echo "Pipeline Results:"
          echo "- Validation: ${{ needs.validate-release.result }}"
          echo "- CI Pipeline: ${{ needs.ci-for-release.result }}"
          echo "- Build: ${{ needs.build-release.result }}"
          echo "- npm Publish: ${{ needs.publish-npm.result }}"
          echo "- GitHub Release: ${{ needs.create-github-release.result }}"
          echo "- Production Deploy: ${{ needs.deploy-production.result }}"
          
          if [[ "${{ needs.validate-release.result }}" == "success" && 
                "${{ needs.ci-for-release.result }}" == "success" && 
                "${{ needs.build-release.result }}" == "success" && 
                "${{ needs.publish-npm.result }}" == "success" && 
                "${{ needs.create-github-release.result }}" == "success" ]]; then
            echo ""
            echo "ðŸŽ‰ Release ${{ needs.validate-release.outputs.version }} completed successfully!"
            exit 0
          else
            echo ""
            echo "âŒ Release pipeline failed"
            exit 1
          fi